<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Editor SQL ‚Äì REDMUEM</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --rose:#EE9B81;
  --orange:#FF7A33;
  --green:#4CAF50;
  --yellow:#FFCF3F;
  --bg:#FFF3EE;
  --white:#fff;
  --shadow:0 6px 20px rgba(0,0,0,0.10);
}

body{
  background:linear-gradient(to bottom,var(--bg),#fff);
  overflow-x:hidden;
  font-family:system-ui;
}

/* SIDEBAR (lo dej√© igual) */
.sidebar{
  position:fixed;
  top:0;
  left:-280px;
  height:100%;
  width:260px;
  background:linear-gradient(135deg,var(--rose),var(--orange));
  color:white;
  padding:20px 0;
  box-shadow:10px 0 30px rgba(0,0,0,0.25);
  transition:0.35s;
  z-index:9999;
  border-top-right-radius:25px;
  border-bottom-right-radius:25px;
}
.sidebar.open{ left:0; }

/* ----------------------- SIDEBAR MEJORADO ----------------------- */

/* Fondo oscuro cuando se abre */
#overlayMenu{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(3px);
  display: none;
  z-index: 9000;
}

/* Men√∫ lateral m√°s bonito */
.sidebar{
  position:fixed;
  top:0;
  left:-260px;
  width:240px;
  height:100%;
  background:linear-gradient(160deg, var(--rose), var(--orange));
  padding:25px 0;
  color:white;
  border-top-right-radius:22px;
  border-bottom-right-radius:22px;
  box-shadow: 10px 0 25px rgba(0,0,0,0.25);
  transition: left .35s ease-in-out;
}

.sidebar.open{
  left:0;
}

/* T√≠tulo */
.sidebar-title{
  font-size:20px;
  font-weight:900;
  padding:0 25px 15px;
  margin-bottom:10px;
  border-bottom:2px solid rgba(255,255,255,0.25);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* Bot√≥n cerrar m√°s visible */
.sidebar-close{
  font-size:22px;
  cursor:pointer;
}

/* Items del men√∫ */
.menu-item{
  padding:15px 25px;
  font-size:17px;
  display:flex;
  align-items:center;
  gap:12px;
  cursor:pointer;
  transition:.25s;
  border-radius:12px;
  margin:6px 12px;
}

/* Hover */
.menu-item:hover{
  background:rgba(255,255,255,0.25);
  transform: translateX(4px);
}

/* √çconos m√°s limpios */
.menu-item::before{
  font-size:20px;
  opacity:0.9;
}

/* Que el men√∫ sea scrollable si hay m√°s elementos */
.sidebar{
  overflow-y:auto;
}


/* HEADER DEL DASHBOARD */
.header-redmuem{
  background:linear-gradient(135deg,var(--rose),var(--orange));
  padding:22px;
  color:white;
  font-weight:900;
  font-size:24px;
  box-shadow:var(--shadow);
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
  z-index:1000;
}

/* üëá A√ëADIDO PARA EVITAR EL CHOQUE CON LA BARRA SUPERIOR */
@supports(padding: max(0px)) {
  body {
    padding-top: env(safe-area-inset-top);
  }
  .header-redmuem {
    padding-top: calc(env(safe-area-inset-top) + 20px);
  }
}
</style>
</head>

<body>

<div id="overlayMenu" onclick="toggleMenu()"></div>

<div id="sideMenu" class="sidebar">
  <div class="sidebar-title">
    Panel Admin
    <span class="sidebar-close" onclick="toggleMenu()">‚úñ</span>
  </div>

  <div class="menu-item" onclick="irInicio()">üè† <span>Inicio</span></div>
  <div class="menu-item" onclick="abrirTabla('usuarios')">üë§ <span>Usuarios</span></div>
  <div class="menu-item" onclick="abrirTabla('ofertas')">üè∑ <span>Ofertas</span></div>
  <div class="menu-item" onclick="abrirTabla('conveniosyalianzas')">ü§ù <span>Convenios</span></div>
  <div class="menu-item" onclick="abrirTabla('carousel_inicio')">üñº <span>Carrusel Inicio</span></div>

</div>

<header class="header-redmuem">
  <span class="menu-btn" onclick="toggleMenu()">‚ò∞</span>
  Editor SQL
  <!-- üîπ BOT√ìN SALIR FUNCIONAL -->
  <button
    onclick="salir()"
    class="bg-white text-orange-600 px-4 py-1 rounded-xl font-bold shadow">
    Salir
  </button>
</header>

<main class="p-4">
  <div id="vistaInicio" class="grid grid-cols-1 sm:grid-cols-2 gap-6 text-center"></div>

  <button id="btnNuevo"
    class="hidden bg-gradient-to-r from-[var(--rose)] to-[var(--orange)] text-white p-3 rounded-xl font-bold mb-4 w-full">
    + Crear Nuevo Registro
  </button>

  <!-- üîç BARRA DE B√öSQUEDA OFERTAS -->
  <div id="busquedaOfertas" class="hidden mt-4">
    <input id="inputBuscarOfertas"
      type="text"
      placeholder="Buscar ofertas..."
      class="w-full p-2 border rounded-xl mb-2">

    <div class="flex gap-2">
      <button onclick="filtrarOfertas('nuevas')" class="px-3 py-1 bg-orange-500 text-white rounded-xl">
        M√°s nuevas
      </button>
      <button onclick="filtrarOfertas('caducar')" class="px-3 py-1 bg-orange-500 text-white rounded-xl">
        Pr√≥ximas a caducar
      </button>
    </div>
  </div>

  <!-- üîç BARRA DE B√öSQUEDA CONVENIOS -->
  <div id="busquedaConvenios" class="hidden mt-4">
    <input id="inputBuscarConvenios"
      type="text"
      placeholder="Buscar convenios o alianzas..."
      class="w-full p-2 border rounded-xl mb-2">

    <div class="flex gap-2">
      <button onclick="filtrarConvenios('Convenio')" class="px-3 py-1 bg-orange-500 text-white rounded-xl">
        Convenios
      </button>
      <button onclick="filtrarConvenios('Alianza')" class="px-3 py-1 bg-orange-500 text-white rounded-xl">
        Alianzas
      </button>
      <button onclick="cargarRegistros()" class="px-3 py-1 bg-gray-500 text-white rounded-xl">
        Todos
      </button>
    </div>
  </div>

  <div id="registros" class="grid gap-4"></div>
</main>

<!-- MODAL NUEVO -->
<div id="modalNuevo" class="hidden fixed inset-0 bg-black/50 backdrop-blur-md flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl p-6 max-w-lg w-full max-h-[85vh] overflow-y-auto shadow-xl">
    <h2 class="text-xl font-bold mb-4">Crear Nuevo Registro</h2>
    <form id="formNuevo" class="space-y-4"></form>

    <div class="flex justify-end gap-3 mt-4">
      <button type="button" onclick="cerrarModalNuevo()" class="px-4 py-2 bg-gray-400 text-white rounded">Cancelar</button>
      <button type="button" onclick="guardarNuevo()" class="bg-gradient-to-r from-[var(--rose)] to-[var(--orange)] text-white px-5 py-2 rounded-xl font-bold">
        Guardar
      </button>
    </div>
  </div>
</div>

<!-- MODAL EDITAR -->
<div id="modalEditar" class="hidden fixed inset-0 bg-black/50 backdrop-blur-md flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl p-6 max-w-lg w-full max-h-[85vh] overflow-y-auto shadow-xl">
    <h2 class="text-xl font-bold mb-4">Editar Registro</h2>
    <form id="formEditar" class="space-y-4"></form>

    <div class="flex justify-end gap-3 mt-4">
      <button type="button" onclick="cerrarModalEditar()" class="px-4 py-2 bg-gray-400 text-white rounded">Cancelar</button>
      <button type="button" onclick="guardarEdicion()" class="bg-blue-600 text-white px-5 py-2 rounded-xl font-bold">
        Guardar cambios
      </button>
    </div>
  </div>
</div>


<!-- VISOR IMAGEN (zoom) -->
<div id="imgViewerBg" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-[9999]" onclick="cerrarImgGrande()">
  <img id="imgViewer" class="max-w-[92vw] max-h-[92vh] rounded-2xl shadow-2xl border border-white/20" />
</div>

<script>

/* ------------------------ MENU ------------------------ */
function toggleMenu() {
  const menu = document.getElementById("sideMenu");
  const overlay = document.getElementById("overlayMenu");
  menu.classList.toggle("open");
  overlay.style.display = menu.classList.contains("open") ? "block" : "none";
}

/* ------------------------ SALIR A INDEX ------------------------ */
function salir() {
  // Cambia "index.html" si tu archivo principal se llama distinto o est√° en otra ruta
  window.location.href = "index.html";
}

/* ------------------------ TOGGLE PASSWORD ------------------------ */
function togglePassword(id, btn) {
  const input = document.getElementById(id);
  if (!input) return;

  if (input.type === "password") {
    input.type = "text";
    if (btn) btn.textContent = "Ocultar";
  } else {
    input.type = "password";
    if (btn) btn.textContent = "Ver";
  }
}

/* ------------------------ SUPABASE ------------------------ */
// üîê ADMIN (dashboard, BD, auth, deletes, etc.)
const supabaseAdmin = supabase.createClient(
  "https://qfcffqpfjvbrdkcldybb.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmY2ZmcXBmanZicmRrY2xkeWJiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MzAzODg3NSwiZXhwIjoyMDc4NjE0ODc1fQ.U_63Pu3RXS3RJIB7behzZiTibAf9BhMS2brNqI_q90I"
);

// üåç PUBLIC (solo storage, im√°genes)
const supabasePublic = supabase.createClient(
  "https://qfcffqpfjvbrdkcldybb.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmY2ZmcXBmanZicmRrY2xkeWJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMzg4NzUsImV4cCI6MjA3ODYxNDg3NX0.G5QfI3yFvOy-h8bOI3VuQFS7PoqAoY97cmqOVcaKVmA"
);

// ‚ö†Ô∏è compatibilidad con tu c√≥digo actual
const client = supabaseAdmin;

let tablaActual = "";
let registroEditando = null;

/* ------------------------ INICIO ------------------------ */
document.addEventListener("DOMContentLoaded", cargarTarjetasInicio);

async function cargarTarjetasInicio() {
  const cont = document.getElementById("vistaInicio");
  cont.innerHTML = "";

  const tablas = [
    { nombre:"usuarios", titulo:"Usuarios", icon:"üë§" },
    { nombre:"ofertas", titulo:"Ofertas", icon:"üè∑" },
    { nombre:"conveniosyalianzas", titulo:"Convenios", icon:"ü§ù" }
  ];

  for (let t of tablas) {
    const { count } = await client.from(t.nombre)
      .select("*", { count: "exact", head: true });

    cont.innerHTML += `
      <div class="bg-white rounded-2xl shadow p-6 cursor-pointer"
           onclick="abrirTabla('${t.nombre}')">
        <div class="text-5xl mb-2">${t.icon}</div>
        <div class="text-4xl font-bold text-orange-500">${count ?? 0}</div>
        <div class="text-lg font-semibold">${t.titulo}</div>
      </div>`;
  }
}

/* ------------------------ ABRIR TABLA ------------------------ */
function abrirTabla(nombre) {
  tablaActual = nombre;
  document.getElementById("vistaInicio").classList.add("hidden");

  const btnNuevo = document.getElementById("btnNuevo");
  const barraOfertas = document.getElementById("busquedaOfertas");
  const barraConvenios = document.getElementById("busquedaConvenios");

  btnNuevo.classList.add("hidden");
  barraOfertas.classList.add("hidden");
  barraConvenios.classList.add("hidden");

  if (nombre === "ofertas") barraOfertas.classList.remove("hidden");
  else btnNuevo.classList.remove("hidden");

  if (nombre === "conveniosyalianzas") barraConvenios.classList.remove("hidden");

  cargarRegistros();
}

/* ------------------------ LISTAR REGISTROS ------------------------ */
async function cargarRegistros() {
  const cont = document.getElementById("registros");
  cont.innerHTML = "";

  let query = client.from(tablaActual).select("*");

  if (tablaActual === "ofertas") {
    const search = document.getElementById("inputBuscarOfertas")?.value || "";
    if (search.trim() !== "") query = query.ilike("titulo", `%${search}%`);
  }

  if (tablaActual === "conveniosyalianzas") {
    const search = document.getElementById("inputBuscarConvenios")?.value || "";
    if (search.trim() !== "") query = query.ilike("institucion", `%${search}%`);
  }

  const { data } = await query;

  (data || []).forEach(row => cont.appendChild(crearCard(row)));
}

function crearCard(row) {

  /* ===============================
     üñº CASO ESPECIAL: CARRUSEL INICIO
  =============================== */
  if (tablaActual === "carousel_inicio") {
    const card = document.createElement("div");
    card.className = "bg-white p-4 rounded-2xl shadow-md flex items-center justify-between";

    const img = row.imagen_url || "";
    card.innerHTML = `
      <div class="flex items-center gap-4">
        ${img ? `<img src="${img}" class="w-20 h-20 object-cover rounded-xl border cursor-zoom-in" onclick="verImgGrande('${img}')">`
              : `<div class="preview-vacio w-20 h-20 text-3xl flex items-center justify-center">üñº</div>`}
        <div>
          <p class="font-bold text-lg">Imagen del carrusel</p>
          <div class="flex gap-2 mt-1">
            <span class="px-3 py-1 text-white rounded-full text-sm ${row.activo ? 'bg-green-500' : 'bg-gray-400'}">${row.activo ? 'Activo' : 'Oculto'}</span>
            <span class="px-3 py-1 bg-orange-500 text-white rounded-full text-sm">Orden: ${row.orden ?? 0}</span>
          </div>
        </div>
      </div>
      <div class="flex gap-3">
        <button onclick="editar('${row.id}')" class="p-2 rounded-xl border border-blue-500 text-blue-500">‚úè</button>
        <button onclick="eliminar('${row.id}')" class="p-2 rounded-xl border border-red-500 text-red-600">üóë</button>
      </div>
    `;
    return card;
  }

  const card = document.createElement("div");
  card.className =
    "bg-white p-4 rounded-2xl shadow-md flex items-center justify-between";

  const campoImagen = Object.keys(row).find(c =>
    c.toLowerCase().includes("imagen") || c.toLowerCase().includes("logo")
  );

  let imagenHTML = `<div class="preview-vacio w-16 h-16 text-3xl">üñº</div>`;

  if (campoImagen && row[campoImagen]) {
    imagenHTML =
      `<img src="${row[campoImagen]}" class="w-16 h-16 object-cover rounded-xl border">`;
  }

  const campoNombre = Object.keys(row).find(c =>
    ["nombre","titulo","email","institucion"].some(n => c.toLowerCase().includes(n))
  );
  const nombre = row[campoNombre] ?? "(Sin nombre)";

  const campoEstado = Object.keys(row).find(c =>
    ["estado","status"].some(n => c.toLowerCase().includes(n))
  );
  const estado = row[campoEstado] ?? "N/A";

  const chip = String(estado).toLowerCase() === "activo"
    ? "bg-green-500"
    : "bg-red-500";

  card.innerHTML = `
    <div class="flex items-center gap-4">
      ${imagenHTML}
      <div>
        <p class="font-bold text-lg">${nombre}</p>
        <span class="px-3 py-1 text-white rounded-full text-sm ${chip}">
          ${estado}
        </span>
      </div>
    </div>

    <div class="flex gap-3">
      <button onclick="editar('${row.id}')"
        class="p-2 rounded-xl border border-blue-500 text-blue-500">‚úè</button>

      <button onclick="eliminar('${row.id}')"
        class="p-2 rounded-xl border border-red-500 text-red-600">üóë</button>
    </div>
  `;

  return card;
}


/* ------------------ BTN NUEVO ESPECIAL PARA USUARIOS ------------------ */
document.getElementById("btnNuevo").addEventListener("click", () => {
  if (tablaActual === "usuarios") mostrarFormularioNuevoUsuarioAuth();
  else mostrarFormularioNuevo();
});

/* ----------- FORMULARIO NORMAL (OTRAS TABLAS) ----------- */
async function mostrarFormularioNuevo() {
  const modal = document.getElementById("modalNuevo");
  const form = document.getElementById("formNuevo");
  form.innerHTML = "";
  modal.classList.remove("hidden");

  /* ------------------ FORMULARIO: CARRUSEL INICIO ------------------ */
  if (tablaActual === "carousel_inicio") {
    form.innerHTML = `
      <div>
        <label>Imagen</label>
        <input type="file" name="imagen_url" class="input-file w-full">
      </div>

      <div>
        <label>Orden</label>
        <input type="number" name="orden" value="0" class="w-full p-2 border rounded-xl">
      </div>

      <div class="flex items-center gap-2">
        <input type="checkbox" name="activo" checked>
        <label>Mostrar en carrusel</label>
      </div>
    `;
    return;
  }

  if (tablaActual === "conveniosyalianzas") {
    form.innerHTML = `
      <div>
        <label>Instituci√≥n</label>
        <input type="text" name="institucion" class="w-full p-2 border rounded-xl">
      </div>

      <div>
        <label>Resumen</label>
        <input type="text" name="resumen" class="w-full p-2 border rounded-xl">
      </div>

      <div>
        <label>Tipo</label>
        <select name="tipo" class="w-full p-2 border rounded-xl">
          <option value="Convenio">Convenio</option>
          <option value="Alianza">Alianza</option>
        </select>
      </div>

      <div>
        <label>Logo</label>
        <input type="file" name="logo" class="input-file w-full">
      </div>
    `;
    return;
  }

  const { data } = await client.from(tablaActual).select("*").limit(1);
  const row0 = data?.[0] || {};
  const campos = Object.keys(row0).filter(c => c !== "id" && c !== "created_at");

  campos.forEach(campo => {
    const esImg = campo.toLowerCase().includes("imagen") || campo.toLowerCase().includes("logo");

    if (esImg) {
  form.innerHTML += `
    <div>
      <label>${campo}</label>
      <img src="${row0[campo] || 'https://via.placeholder.com/80'}"
           class="w-24 h-24 object-cover rounded-xl mb-2 border">
      <input type="file" name="${campo}">
    </div>`;
} 
// üî• CAMPOS LARGOS ‚Üí usar textarea
else if (campo === "descripcion" || campo === "descripcion_empresa") {
  form.innerHTML += `
    <div>
      <label>${campo}</label>
      <textarea name="${campo}" class="w-full p-2 border rounded-xl h-32">${row0[campo] ?? ""}</textarea>
    </div>`;
}
// üî• CAMPOS NORMALES ‚Üí input
else {
  form.innerHTML += `
    <div>
      <label>${campo}</label>
      <input type="text" name="${campo}" value="${row0[campo] ?? ""}"
             class="w-full p-2 border rounded-xl">
    </div>`;
}

  });
}

/* ----------- FORMULARIO CREAR USUARIO AUTH ----------- */
function mostrarFormularioNuevoUsuarioAuth() {
  const modal = document.getElementById("modalNuevo");
  const form = document.getElementById("formNuevo");
  modal.classList.remove("hidden");

  form.innerHTML = `
    <div>
      <label>E-mail</label>
      <input type="email" name="email" class="w-full p-2 rounded-xl border">
    </div>

    <div>
      <label>Contrase√±a</label>
      <div class="relative">
        <input
          type="password"
          name="password"
          id="passwordNuevoUsuario"
          class="w-full p-2 pr-16 rounded-xl border">
        <button
          type="button"
          onclick="togglePassword('passwordNuevoUsuario', this)"
          class="absolute inset-y-0 right-0 px-3 text-sm text-gray-500">
          Ver
        </button>
      </div>
    </div>

    <div>
      <label>Nombre</label>
      <input type="text" name="nombre" class="w-full p-2 rounded-xl border">
    </div>
  `;
}

/* ------------------ GUARDAR NUEVO ------------------ */
async function guardarNuevo() {
  if (tablaActual === "usuarios") return guardarNuevoUsuarioAuth();

  const form = document.getElementById("formNuevo");
  const inputs = form.querySelectorAll("input, select, textarea");

  const dataInsert = {};

  if (inp.type === "file" && inp.files.length > 0) {
  const carpeta = tablaActual === "carousel_inicio"
    ? "carousel"
    : "";

  dataInsert[inp.name] = await subirImagen(inp.files[0], carpeta);
  }

  await client.from(tablaActual).insert(dataInsert);

  cerrarModalNuevo();
  cargarRegistros();
}

/* ----------- CREAR USUARIO AUTH + USUARIOS ----------- */
async function guardarNuevoUsuarioAuth() {
  const form = document.getElementById("formNuevo");
  const email = form.querySelector("input[name='email']").value;
  const password = form.querySelector("input[name='password']").value;
  const nombre = form.querySelector("input[name='nombre']").value;

  const { data: authData, error: authError } = await client.auth.admin.createUser({
    email,
    password,
    email_confirm: true
  });

  if (authError) {
    alert("Error creando usuario: " + authError.message);
    return;
  }

  const userId = authData.user.id;

  await client.from("usuarios").insert({
    auth_user_id: userId,
    email: email,
    nombre: nombre || null
  });

  cerrarModalNuevo();
  cargarRegistros();
}

/* ------------------------ SUBIR IMAGEN ------------------------ */
async function subirImagen(file, carpeta = "") {
  const cleanName = file.name
    .toLowerCase()
    .replace(/[^a-z0-9.]/g, "_");

  const nombreArchivo = Date.now() + "_" + cleanName;

  // üìÅ ruta final dentro del bucket
  const ruta = carpeta
    ? `${carpeta}/${nombreArchivo}`
    : nombreArchivo;

  const { error } = await supabaseAdmin
    .storage
    .from("Fotos")
    .upload(ruta, file, { upsert: false });

  if (error) {
    console.error("Error subiendo imagen:", error);
    throw error;
  }

  return supabaseAdmin
    .storage
    .from("Fotos")
    .getPublicUrl(ruta)
    .data.publicUrl;
}

/* ------------------------ EDITAR ------------------------ */
async function editar(id) {
  registroEditando = id;

  const { data } = await client
    .from(tablaActual)
    .select("*")
    .eq("id", id)
    .single();

  const modal = document.getElementById("modalEditar");
  const form = document.getElementById("formEditar");

  form.innerHTML = "";

  const campos = Object.keys(data).filter(c => c !== "id" && c !== "created_at");

campos.forEach(campo => {

  // Saltar empresa si ya la vamos a a√±adir manualmente despu√©s de descripcion
  if (campo === "descripcion_empresa") return;

  const valor = data[campo] ?? "";
  const esImg = campo.toLowerCase().includes("imagen") || campo.toLowerCase().includes("logo");

  // ---- IM√ÅGENES ----
  if (esImg) {
    form.innerHTML += `
      <div>
        <label>${campo}</label>
        <img src="${valor || 'https://via.placeholder.com/80'}"
             class="w-24 h-24 object-cover rounded-xl mb-2 border">
        <input type="file" name="${campo}">
      </div>`;
  }

  // ---- DESCRIPCI√ìN NORMAL ----
  else if (campo === "descripcion") {
    // Campo normal descripcion
    form.innerHTML += `
      <div>
        <label>${campo}</label>
        <textarea name="${campo}" class="w-full p-2 border rounded-xl h-32">${valor}</textarea>
      </div>`;

    // ‚ö†Ô∏è Meter descripcion_empresa justo despu√©s
    const descEmp = data.descripcion_empresa ?? "";
    form.innerHTML += `
      <div>
        <label>descripcion_empresa</label>
        <textarea name="descripcion_empresa" class="w-full p-2 border rounded-xl h-32">${descEmp}</textarea>
      </div>`;
  }

  // ---- INPUT NORMAL ----
  else {
    form.innerHTML += `
      <div>
        <label>${campo}</label>
        <input type="text" name="${campo}" value="${valor}"
               class="w-full p-2 border rounded-xl">
      </div>`;
  }

});


  modal.classList.remove("hidden");
}

/* ------------------------ CERRAR MODAL EDITAR ------------------------ */
function cerrarModalEditar() {
  const modal = document.getElementById("modalEditar");
  modal.classList.add("hidden");
  registroEditando = null;
}

async function guardarEdicion() {
  const form = document.getElementById("formEditar");
  const inputs = form.querySelectorAll("input, select, textarea");

  const dataUpdate = {};

  for (const inp of inputs) {

    // üì∏ IMAGEN ‚Üí SOLO si el usuario eligi√≥ una nueva
    if (inp.type === "file") {
      if (inp.files && inp.files.length > 0) {
        const carpeta = (tablaActual === "carousel_inicio") ? "carousel" : "";
        const url = await subirImagen(inp.files[0], carpeta);
        dataUpdate[inp.name] = url;
      }
      // ‚ö†Ô∏è si no hay archivo, NO tocar imagen_url
      continue;
    }

    // ‚úÖ CHECKBOX (activo)
    if (inp.type === "checkbox") {
      dataUpdate[inp.name] = inp.checked;
      continue;
    }

    // üü¢ INPUT HIDDEN (activo del carrusel)
    if (inp.type === "hidden") {
      dataUpdate[inp.name] = (inp.value === "true");
      continue;
    }

    // ‚úèÔ∏è CAMPOS NORMALES
    if (inp.name && inp.value !== "") {
      dataUpdate[inp.name] = inp.value;
    }
  }

  // üîê Seguridad extra: si no hay nada que actualizar
  if (Object.keys(dataUpdate).length === 0) {
    alert("No se realizaron cambios");
    return;
  }

  const { error } = await client
    .from(tablaActual)
    .update(dataUpdate)
    .eq("id", registroEditando);

  if (error) {
    console.error(error);
    alert("Error al guardar cambios");
    return;
  }

  cerrarModalEditar();
  cargarRegistros();
}

/* ------------------------ GUARDAR CAMBIOS ------------------------ */
async function guardarNuevo() {
  if (tablaActual === "usuarios") return guardarNuevoUsuarioAuth();

  const form = document.getElementById("formNuevo");
  const inputs = form.querySelectorAll("input, select, textarea");

  const dataInsert = {};

  for (const inp of inputs) {

    // üì∏ ARCHIVOS
    if (inp.type === "file" && inp.files.length > 0) {
      const carpeta = tablaActual === "carousel_inicio"
        ? "carousel"
        : "";

      dataInsert[inp.name] = await subirImagen(inp.files[0], carpeta);
    }

    // ‚úÖ CHECKBOX
    else if (inp.type === "checkbox") {
      dataInsert[inp.name] = inp.checked;
    }

    // ‚úèÔ∏è TEXTO / SELECT / TEXTAREA
    else if (inp.name) {
      dataInsert[inp.name] = inp.value;
    }
  }

  await client.from(tablaActual).insert(dataInsert);

  cerrarModalNuevo();
  cargarRegistros();
}

/* ------------------------ ELIMINAR ------------------------ */
async function eliminar(id) {

  if (tablaActual === "conveniosyalianzas") {
    if (!confirm("¬øEliminar este convenio o alianza?")) return;

    await client.from("conveniosyalianzas").delete().eq("id", id);

    alert("Convenio/Alianza eliminado ‚úîÔ∏è");
    cargarRegistros();
    return;
  }

  if (tablaActual === "usuarios") {
    if (!confirm("¬øEliminar completamente este usuario?")) return;

    const { data: usuario } = await client
      .from("usuarios")
      .select("auth_user_id")
      .eq("id", id)
      .single();

    if (usuario?.auth_user_id) {
      await client.auth.admin.deleteUser(usuario.auth_user_id);
    }

    await client.from("ofertas").delete().eq("usuario_id", id);
    await client.from("usuarios").delete().eq("id", id);

    alert("Usuario eliminado completamente üå™üî•");
    cargarRegistros();
    return;
  }

  if (tablaActual === "ofertas") {
    if (!confirm("¬øEliminar esta oferta?")) return;
    await client.from("ofertas").delete().eq("id", id);
    cargarRegistros();
    return;
  }

  if (!confirm("¬øEliminar este registro?")) return;

  await client.from(tablaActual).delete().eq("id", id);

  cargarRegistros();
}

/* ------------------------ BUSCADORES ------------------------ */
document.addEventListener("DOMContentLoaded", () => {
  const inputOfertas = document.getElementById("inputBuscarOfertas");
  if (inputOfertas) {
    inputOfertas.addEventListener("input", () => {
      if (tablaActual === "ofertas") cargarRegistros();
    });
  }

  const inputConvenios = document.getElementById("inputBuscarConvenios");
  if (inputConvenios) {
    inputConvenios.addEventListener("input", () => {
      if (tablaActual === "conveniosyalianzas") cargarRegistros();
    });
  }
});

/* ------------------------ FILTROS OFERTAS ------------------------ */
async function filtrarOfertas(modo) {
  let query = client.from("ofertas").select("*");

  const search = document.getElementById("inputBuscarOfertas")?.value || "";
  if (search.trim() !== "") query = query.ilike("titulo", `%${search}%`);

  if (modo === "nuevas") query = query.order("fecha_creada", { ascending: false });
  else if (modo === "caducar") query = query.order("fecha_fin", { ascending: true });

  const { data } = await query;
  const cont = document.getElementById("registros");
  cont.innerHTML = "";
  (data || []).forEach(row => cont.appendChild(crearCard(row)));
}

/* ------------------------ FILTROS CONVENIOS ------------------------ */
async function filtrarConvenios(tipo) {
  const search = document.getElementById("inputBuscarConvenios")?.value || "";

  let query = client.from("conveniosyalianzas").select("*").eq("tipo", tipo);

  if (search.trim() !== "") query = query.ilike("institucion", `%${search}%`);

  const { data } = await query;

  const cont = document.getElementById("registros");
  cont.innerHTML = "";
  (data || []).forEach(r => cont.appendChild(crearCard(r)));
}

/* ------------------------ VOLVER A INICIO ------------------------ */
function irInicio() {
  tablaActual = "";

  document.getElementById("vistaInicio").classList.remove("hidden");
  document.getElementById("btnNuevo").classList.add("hidden");
  document.getElementById("registros").innerHTML = "";

  document.getElementById("sideMenu").classList.remove("open");
  document.getElementById("overlayMenu").style.display = "none";

  cargarTarjetasInicio();
}

/* ------------------------ CERRAR MODAL NUEVO ------------------------ */
function cerrarModalNuevo() {
  document.getElementById("modalNuevo").classList.add("hidden");
}


/* ------------------------ VISOR DE IMAGEN ------------------------ */
function verImgGrande(url){
  const img = document.getElementById('imgViewer');
  const bg = document.getElementById('imgViewerBg');
  if (!img || !bg) return;
  img.src = url;
  bg.classList.remove('hidden');
  bg.classList.add('flex');
}
function cerrarImgGrande(){
  const bg = document.getElementById('imgViewerBg');
  if (!bg) return;
  bg.classList.add('hidden');
  bg.classList.remove('flex');
}

function toggleActivoCarrusel() {
  const input = document.getElementById("inputActivo");
  const btn = document.getElementById("btnToggleActivo");
  const txt = document.getElementById("estadoTexto");

  if (!input || !btn || !txt) return;

  const actual = (String(input.value) === "true");
  const nuevo = !actual;

  input.value = String(nuevo);

  if (nuevo) {
    btn.textContent = "Desactivar";
    btn.classList.remove("bg-gray-600");
    btn.classList.add("bg-green-600");
    txt.textContent = "Activo (se muestra)";
  } else {
    btn.textContent = "Activar";
    btn.classList.remove("bg-green-600");
    btn.classList.add("bg-gray-600");
    txt.textContent = "Inactivo (oculto)";
  }
}

</script>

</body>
</html>
